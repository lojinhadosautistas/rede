<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema REDE | LUCAS – Agente de IA</title>

  <!-- Bootstrap + Icons -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-main: #f4f6f9;
      --bg-sidebar: #0f172a;
      --bg-card: #ffffff;
      --primary: #2563eb;
      --text-main: #0f172a;
      --text-muted: #64748b;
    }

    body { font-family: "Inter", sans-serif; background: var(--bg-main); margin: 0; }

    .topbar { height: 60px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
    .topbar .brand { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
    .topbar .actions a { margin-left: 15px; text-decoration: none; color: var(--text-muted); font-weight: 500; }
    .topbar .actions a:hover { color: var(--primary); }
    .topbar .actions #userEmail { margin-left: 15px; font-weight: 500; color: var(--primary); font-style: italic; font-size: 0.9rem; }

    .sidebar { position: fixed; top: 60px; left: 0; width: 240px; height: calc(100vh - 60px); background: var(--bg-sidebar); padding: 20px 0; overflow-y: auto; }
    .sidebar h6 { color: #94a3b8; font-size: 0.75rem; padding: 0 20px; margin-top: 20px; text-transform: uppercase; letter-spacing: 0.08em; }
    .sidebar a { display: flex; align-items: center; gap: 10px; padding: 10px 20px; color: #e5e7eb; text-decoration: none; font-size: 0.95rem; border-left: 3px solid transparent; }
    .sidebar a:hover, .sidebar a.active { background: rgba(255, 255, 255, 0.08); border-left: 3px solid var(--primary); color: #fff; }

    .main { margin-left: 240px; padding: 90px 30px 30px; }
    .page-title h1 { font-size: 1.6rem; font-weight: 700; color: var(--text-main); }
    .page-title p { color: var(--text-muted); margin-top: 5px; }
    .module-card { background: var(--bg-card); border-radius: 16px; padding: 25px; height: 100%; box-shadow: 0 6px 18px rgba(0,0,0,0.06); transition: transform 0.2s ease; }
    .module-card:hover { transform: translateY(-4px); }
    .module-card h3 { margin-top: 15px; font-size: 1.2rem; font-weight: 600; }
    .module-card p { color: var(--text-muted); font-size: 0.95rem; }

    #chatWindow { height: 220px; overflow-y: auto; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
    #chatWindow p { margin: 5px 0; }

    @media (max-width: 992px) { .sidebar { display: none; } .main { margin-left: 0; } }
  </style>
</head>
<body>

<div class="topbar">
  <div class="brand">Sistema REDE</div>
  <div class="actions">
    <a href="../index.html">Site</a>
    <span id="userEmail">Visitante</span>
  </div>
</div>

<aside class="sidebar">
  <h6>Dashboard</h6>
  <a href="hub.html"><i class="bi bi-grid"></i> Hub Interno</a>
  <h6>Ferramentas</h6>
  <a href="lucas.html" class="active"><i class="bi bi-shield-lock"></i> LUCAS – Agente de IA</a>
</aside>

<main class="main">
  <div class="page-title mb-4">
    <h1>LUCAS – Agente de IA</h1>
    <p>Agente institucional de análise, curadoria e apoio estratégico do Sistema REDE.</p>
  </div>

  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="module-card">
        <h3>Contexto do Agente</h3>
        <p>O LUCAS opera com base em todos os documentos autorizados e gera resumos inteligentes antes de responder.</p>
        <span class="badge bg-primary">Modo institucional</span>
        <span class="badge bg-secondary">Acesso controlado</span>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="module-card" style="min-height: 380px;">
        <div id="chatWindow">
          <p class="text-muted"><strong>LUCAS:</strong> Estou pronto para analisar documentos e responder perguntas com base em resumos inteligentes.</p>
        </div>

        <form id="lucasForm">
          <textarea class="form-control mb-3" rows="3" placeholder="Digite sua pergunta..." required></textarea>
          <button type="submit" class="btn btn-primary">Enviar para o LUCAS</button>
        </form>
      </div>
    </div>
  </div>
</main>

<script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js"></script>

<script>
  const chatWindow = document.getElementById("chatWindow");
  const lucasForm = document.getElementById("lucasForm");
  const docsFolder = "./bucket/docs/";
  let docsText = "";
  let summaryText = "";
  let model;

  async function loadDocs() {
    try {
      const indexRes = await fetch(docsFolder + "index.json");
      const indexData = await indexRes.json();
      const contents = await Promise.all(
        indexData.files.map(async (f) => {
          const r = await fetch(docsFolder + f);
          return await r.text();
        })
      );
      docsText = contents.join("\n\n");
      console.log("Documentos carregados:", indexData.files.length);
    } catch (err) {
      console.error("Erro ao carregar documentos:", err);
    }
  }

  async function initModel() {
    model = await window.Transformers.AutoModelForCausalLM.from_pretrained("gpt2");
    console.log("Modelo GPT2 carregado");
  }

  async function summarizeDocs() {
    if (!model) return "Resumo não disponível ainda.";
    const prompt = `Resuma os seguintes documentos de forma clara e concisa:\n\n${docsText}`;
    const output = await model.generate(prompt, { max_new_tokens: 200 });
    summaryText = output.generated_text.replace(prompt, "").trim();
    console.log("Resumo gerado");
  }

  async function getAnswer(question) {
    if (!model) return "Modelo ainda carregando...";
    const prompt = `Use este resumo para responder a pergunta:\n\nRESUMO:\n${summaryText}\n\nPERGUNTA:\n${question}`;
    const output = await model.generate(prompt, { max_new_tokens: 150 });
    return output.generated_text.replace(prompt, "").trim();
  }

  // Inicializa documentos e modelo
  loadDocs().then(() => summarizeDocs());
  initModel();

  lucasForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const textarea = lucasForm.querySelector("textarea");
    const pergunta = textarea.value.trim();
    if (!pergunta) return;

    const userMsg = document.createElement("p");
    userMsg.innerHTML = `<strong>Você:</strong> ${pergunta}`;
    chatWindow.appendChild(userMsg);

    const lucasMsg = document.createElement("p");
    lucasMsg.innerHTML = `<strong>LUCAS:</strong> analisando...`;
    chatWindow.appendChild(lucasMsg);

    chatWindow.scrollTop = chatWindow.scrollHeight;
    textarea.value = "";

    const answer = await getAnswer(pergunta);

    lucasMsg.innerHTML = `<strong>LUCAS:</strong> ${answer}`;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  });
</script>
</body>
</html>
